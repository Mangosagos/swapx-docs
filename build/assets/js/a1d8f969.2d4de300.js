"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7869],{5358:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>i,metadata:()=>o,toc:()=>h});const o=JSON.parse('{"id":"sdk/v3/guides/swaps/quoting","title":"quoting","description":"Introduction","source":"@site/docs/sdk/v3/guides/swaps/01-quoting.md","sourceDirName":"sdk/v3/guides/swaps","slug":"/sdk/v3/guides/swaps/quoting","permalink":"/sdk/v3/guides/swaps/quoting","draft":false,"unlisted":false,"editUrl":"https://github.com/hi-swapx/docs/docs/sdk/v3/guides/swaps/01-quoting.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_label":"\u83b7\u53d6\u62a5\u4ef7","sidebar_position":1},"sidebar":"sdkSidebar","previous":{"title":"\u5151\u6362","permalink":"/category/\u5151\u6362-1"},"next":{"title":"\u6267\u884c\u4ea4\u6613","permalink":"/sdk/v3/guides/swaps/trading"}}');var s=n(4848),r=n(8453);const i={sidebar_label:"\u83b7\u53d6\u62a5\u4ef7",sidebar_position:1},a=void 0,c={},h=[{value:"Introduction",id:"introduction",level:2},{value:"Example configuration",id:"example-configuration",level:2},{value:"Computing the Pool&#39;s deployment address",id:"computing-the-pools-deployment-address",level:2},{value:"Referencing the Pool contract and fetching metadata",id:"referencing-the-pool-contract-and-fetching-metadata",level:2},{value:"Referencing the Quoter contract and getting a quote",id:"referencing-the-quoter-contract-and-getting-a-quote",level:2},{value:"Next Steps",id:"next-steps",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,s.jsxs)(t.p,{children:["This guide will cover how to get the current quotes for any token pair on the SwapX protocol. It is based on the ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/tree/main/v3-sdk/quoting",children:"Quoting code example"}),", found in the SwapX code examples ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples",children:"repository"}),". To run this example, check out the examples's ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/README.md",children:"README"})," and follow the setup instructions."]}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsxs)(t.p,{children:["If you need a briefer on the SDK and to learn more about how these guides connect to the examples repository, please visit our ",(0,s.jsx)(t.a,{href:"01-background",children:"background"})," page!"]})}),"\n",(0,s.jsxs)(t.p,{children:["In this example we will use ",(0,s.jsx)(t.code,{children:"quoteExactInputSingle"})," to get a quote for the pair ",(0,s.jsx)(t.strong,{children:"USDC - WETH"}),".\nThe inputs are the ",(0,s.jsx)(t.strong,{children:"token in"}),", the ",(0,s.jsx)(t.strong,{children:"token out"}),", the ",(0,s.jsx)(t.strong,{children:"amount in"})," and the ",(0,s.jsx)(t.strong,{children:"fee"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.strong,{children:"fee"})," input parameters represents the swap fee that distributed to all in range liquidity at the time of the swap. It is one of the identifiers of a Pool, the others being ",(0,s.jsx)(t.strong,{children:"tokenIn"})," and ",(0,s.jsx)(t.strong,{children:"tokenOut"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["The guide will ",(0,s.jsx)(t.strong,{children:"cover"}),":"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Computing the Pool's deployment address"}),"\n",(0,s.jsx)(t.li,{children:"Referencing the Pool contract and fetching metadata"}),"\n",(0,s.jsx)(t.li,{children:"Referencing the Quoter contract and getting a quote"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"At the end of the guide, we should be able to fetch a quote for the given input token pair and the input token amount with the press of a button on the web application."}),"\n",(0,s.jsx)(t.p,{children:"For this guide, the following SwapX packages are used:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://www.npmjs.com/package/@swapx/v3-sdk",children:(0,s.jsx)(t.code,{children:"@swapx/v3-sdk"})})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://www.npmjs.com/package/@swapx/sdk-core",children:(0,s.jsx)(t.code,{children:"@swapx/sdk-core"})})}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["The core code of this guide can be found in ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/src/libs/quote.ts",children:(0,s.jsx)(t.code,{children:"quote.ts"})})]}),"\n",(0,s.jsx)(t.h2,{id:"example-configuration",children:"Example configuration"}),"\n",(0,s.jsxs)(t.p,{children:["We will use the example configuration ",(0,s.jsx)(t.code,{children:"CurrentConfig"})," in most code snippets of this guide. It has the format:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:"import { Token } from '@swapx/sdk-core'\n\ninterface ExampleConfig {\n  rpc: {\n    local: string\n    mainnet: string\n  }\n  tokens: {\n    in: Token\n    amountIn: number\n    out: Token\n    poolFee: number\n  }\n}\n\nexport const CurrentConfig: ExampleConfig = {...}\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The default config of the example uses a local fork of mainnet. If you haven't already, check out our ",(0,s.jsx)(t.a,{href:"02-local-development",children:"local development guide"}),".\nTo change the rpc endpoint or the Pool used, edit the ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/src/config.ts#L21",children:(0,s.jsx)(t.code,{children:"Currentconfig"})}),".\nTo connect to mainnet directly, set the ",(0,s.jsx)(t.code,{children:"mainnet"})," field in the config:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'export const CurrentConfig: ExampleConfig = {\n  rpc: {\n    local: "http://localhost:8545",\n    mainnet: "https://mainnet.infura.io/v3/0ac57a06f2994538829c14745750d721",\n  },\n  tokens: {\n    in: USDC_TOKEN,\n    amountIn: 1000,\n    out: WETH_TOKEN,\n    poolFee: FeeAmount.MEDIUM,\n  },\n};\n'})}),"\n",(0,s.jsxs)(t.p,{children:["The pool used is defined by a pair of tokens in ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/src/libs/constants.ts#L14",children:(0,s.jsx)(t.code,{children:"constants.ts"})}),".\nYou can also change these two tokens and the fee of the pool in the config, just make sure a Pool actually exists for your configuration.\nCheck out the top pools on ",(0,s.jsx)(t.a,{href:"https://info.SwapX.org/#/pools",children:"SwapX info"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"computing-the-pools-deployment-address",children:"Computing the Pool's deployment address"}),"\n",(0,s.jsxs)(t.p,{children:["To interact with the ",(0,s.jsx)(t.strong,{children:"USDC - WETH"})," Pool contract, we first need to compute its deployment address.\nIf you haven't worked directly with smart contracts yet, check out this ",(0,s.jsx)(t.a,{href:"https://docs.alchemy.com/docs/smart-contract-basics",children:"guide"})," from Alchemy.\nThe SDK provides a utility method for that:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'import { computePoolAddress } from "@swapx/v3-sdk";\n\nconst currentPoolAddress = computePoolAddress({\n  factoryAddress: POOL_FACTORY_CONTRACT_ADDRESS,\n  tokenA: CurrentConfig.tokens.in,\n  tokenB: CurrentConfig.tokens.out,\n  fee: CurrentConfig.tokens.poolFee,\n});\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Since each ",(0,s.jsx)(t.em,{children:"SwapX V3 Pool"})," is uniquely identified by 3 characteristics (token in, token out, fee), we use those\nin combination with the address of the ",(0,s.jsx)(t.em,{children:"PoolFactory"})," contract to compute the address of the ",(0,s.jsx)(t.strong,{children:"USDC - ETH"})," Pool.\nThese parameters have already been defined in our ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/src/libs/constants.ts#L14",children:"constants.ts"})," file:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'const WETH_TOKEN = new Token(\n  1,\n  "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",\n  18,\n  "WETH",\n  "Wrapped Ether"\n);\n\nconst USDC_TOKEN = new Token(\n  1,\n  "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",\n  6,\n  "USDC",\n  "USD//C"\n);\n'})}),"\n",(0,s.jsxs)(t.p,{children:["These constants are used in the ",(0,s.jsx)(t.code,{children:"config.ts"})," file, as mentioned in the Introduction."]}),"\n",(0,s.jsxs)(t.p,{children:["We can find the Pool Factory Contract address for our chain ",(0,s.jsx)(t.a,{href:"contracts/v3/reference/Deployments",children:"here"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"referencing-the-pool-contract-and-fetching-metadata",children:"Referencing the Pool contract and fetching metadata"}),"\n",(0,s.jsxs)(t.p,{children:["Now that we have the deployment address of the ",(0,s.jsx)(t.strong,{children:"USDC - ETH"})," Pool, we can construct an instance of an ",(0,s.jsx)(t.strong,{children:"ethers"})," ",(0,s.jsx)(t.code,{children:"Contract"})," to interact with it:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'import { ethers } from "ethers";\n\nconst provider = new ethers.providers.JsonRpcProvider(rpcUrl);\nconst poolContract = new ethers.Contract(\n  currentPoolAddress,\n  ISwapXV3PoolABI.abi,\n  provider\n);\n'})}),"\n",(0,s.jsxs)(t.p,{children:["To construct the ",(0,s.jsx)(t.em,{children:"Contract"})," we need to provide the address of the contract, its ABI and the provider that will carry out the RPC call for us.\nWe get access to the contract's ABI through the ",(0,s.jsx)(t.a,{href:"https://www.npmjs.com/package/@swapx/v3-core",children:"@swapx/v3-core"})," package, which holds the core smart contracts of the SwapX V3 protocol:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'import ISwapXV3PoolABI from "@swapx/v3-core/artifacts/contracts/interfaces/ISwapXV3Pool.sol/ISwapXV3Pool.json";\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Having constructed our reference to the contract, we can now access its methods through our provider.\nWe use a batch ",(0,s.jsx)(t.code,{children:"Promise"})," call. This approach queries state data concurrently, rather than sequentially, to minimize the chance of fetching out of sync data that may be returned if sequential queries are executed over the span of two blocks:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:"const [token0, token1, fee, liquidity, slot0] = await Promise.all([\n  poolContract.token0(),\n  poolContract.token1(),\n  poolContract.fee(),\n  poolContract.liquidity(),\n  poolContract.slot0(),\n]);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The return values of these methods will become inputs to the quote fetching function.\nThe ",(0,s.jsx)(t.code,{children:"token0"})," and ",(0,s.jsx)(t.code,{children:"token1"})," variables are the addresses of the tokens in the Pool and should not be mistaken for ",(0,s.jsx)(t.code,{children:"Token"})," objects from the sdk.\nFor the full code, check out ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/src/libs/quote.ts#L35",children:(0,s.jsx)(t.code,{children:"getPoolConstants()"})})," in ",(0,s.jsx)(t.code,{children:"quote.ts"}),"."]}),"\n",(0,s.jsx)(t.admonition,{type:"note",children:(0,s.jsx)(t.p,{children:"In this example, the metadata we fetch is already present in our inputs. This guide fetches this information first in order to show how to fetch any metadata, which will be expanded on in future guides."})}),"\n",(0,s.jsx)(t.h2,{id:"referencing-the-quoter-contract-and-getting-a-quote",children:"Referencing the Quoter contract and getting a quote"}),"\n",(0,s.jsxs)(t.p,{children:["To get quotes for trades, SwapX has deployed a ",(0,s.jsx)(t.strong,{children:"Quoter Contract"}),". We will use this contract to fetch the output amount we can expect for our trade, without actually executing the trade.\nCheck out the full code for the following snippets in ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/quoting/src/libs/quote.ts",children:"quote.ts"})]}),"\n",(0,s.jsxs)(t.p,{children:["Like we did for the Pool contract, we need to construct an instance of an ",(0,s.jsx)(t.strong,{children:"ethers"})," ",(0,s.jsx)(t.code,{children:"Contract"})," for our Quoter contract in order to interact with it:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:"const quoterContract = new ethers.Contract(\n  QUOTER_CONTRACT_ADDRESS,\n  Quoter.abi,\n  getProvider()\n);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["We get access to the contract's ABI through the ",(0,s.jsx)(t.a,{href:"https://www.npmjs.com/package/@swapx/v3-periphery",children:"@swapx/v3-periphery"})," package, which holds the periphery smart contracts of the SwapX V3 protocol:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:'import Quoter from "@swapx/v3-periphery/artifacts/contracts/lens/Quoter.sol/Quoter.json";\n'})}),"\n",(0,s.jsxs)(t.p,{children:["We get the QUOTE_CONTRACT_ADDRESS for our chain from ",(0,s.jsx)(t.a,{href:"https://github.com/SwapX/v3-periphery/blob/main/deploys.md",children:"Github"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"We can now use our Quoter contract to obtain the quote."}),"\n",(0,s.jsxs)(t.p,{children:["In an ideal world, the quoter functions would be ",(0,s.jsx)(t.code,{children:"view"})," functions, which would make them very easy to query on-chain with minimal gas costs. However, the SwapX V3 Quoter contracts rely on state-changing calls designed to be reverted to return the desired data. This means calling the quoter will be very expensive and should not be called on-chain."]}),"\n",(0,s.jsxs)(t.p,{children:["To get around this difficulty, we can use the ",(0,s.jsx)(t.code,{children:"callStatic"})," method provided by the ",(0,s.jsx)(t.strong,{children:"ethers.js"})," ",(0,s.jsx)(t.code,{children:"Contract"})," instances.\nThis is a useful method that submits a state-changing transaction to an Ethereum node, but asks the node to simulate the state change, rather than to execute it. Our script can then return the result of the simulated state change:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-typescript",children:"const quotedAmountOut = await quoterContract.callStatic.quoteExactInputSingle(\n  token0,\n  token1,\n  fee,\n  fromReadableAmount(\n    CurrentConfig.tokens.amountIn,\n    CurrentConfig.tokens.in.decimals\n  ).toString(),\n  0\n);\n"})}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"fromReadableAmount()"})," function creates the amount of the smallest unit of a token from the full unit amount and the decimals."]}),"\n",(0,s.jsx)(t.p,{children:"The result of the call is the number of output tokens you'd receive for the quoted swap."}),"\n",(0,s.jsxs)(t.p,{children:["It should be noted that ",(0,s.jsx)(t.code,{children:"quoteExactInputSingle"})," is only 1 of 4 different methods that the quoter offers:"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"quoteExactInputSingle"})," - given the amount you want to swap, produces a quote for the amount out for a swap of a single pool"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"quoteExactInput"})," - given the amount you want to swap, produces a quote for the amount out for a swap over multiple pools"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"quoteExactOutputSingle"})," - given the amount you want to get out, produces a quote for the amount in for a swap over a single pool"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"quoteExactOutput"})," - given the amount you want to get out, produces a quote for the amount in for a swap over multiple pools"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["If we want to trade two tokens that do not share a pool with each other, we will need to make swaps over multiple pools.\nThis is where the ",(0,s.jsx)(t.code,{children:"quoteExactInput"})," and ",(0,s.jsx)(t.code,{children:"quoteExactOutput"})," methods come in.\nWe will dive deeper into routing in the ",(0,s.jsx)(t.a,{href:"03-routing",children:"routing guide"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["For the ",(0,s.jsx)(t.code,{children:"exactOutput"})," and ",(0,s.jsx)(t.code,{children:"exactOutputSingle"})," methods, we need to keep in mind that a pool can not give us more than the amount of Tokens it holds.\nIf we try to get a quote on an output of 100 WETH from a Pool that only holds 50 WETH, the function call will fail."]}),"\n",(0,s.jsx)(t.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(t.p,{children:["Now that you're able to make a quote, check out our next guide on ",(0,s.jsx)(t.a,{href:"02-trading",children:"trading"})," using this quote!"]})]})}function l(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var o=n(6540);const s={},r=o.createContext(s);function i(e){const t=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);