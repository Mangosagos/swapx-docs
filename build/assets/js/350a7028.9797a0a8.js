"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4581],{6437:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"sdk/v3/guides/liquidity/modifying-position","title":"modifying-position","description":"Introduction","source":"@site/docs/sdk/v3/guides/liquidity/04-modifying-position.md","sourceDirName":"sdk/v3/guides/liquidity","slug":"/sdk/v3/guides/liquidity/modifying-position","permalink":"/sdk/v3/guides/liquidity/modifying-position","draft":false,"unlisted":false,"editUrl":"https://github.com/hi-swapx/docs/docs/sdk/v3/guides/liquidity/04-modifying-position.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_label":"\u4fee\u6539\u4f4d\u7f6e","sidebar_position":4},"sidebar":"sdkSidebar","previous":{"title":"\u83b7\u53d6\u4f4d\u7f6e","permalink":"/sdk/v3/guides/liquidity/fetching-positions"},"next":{"title":"\u6536\u8d39","permalink":"/sdk/v3/guides/liquidity/collecting-fees"}}');var o=i(4848),s=i(8453);const a={sidebar_label:"\u4fee\u6539\u4f4d\u7f6e",sidebar_position:4},r=void 0,d={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Configuration and utils",id:"configuration-and-utils",level:2},{value:"Adding liquidity to our position",id:"adding-liquidity-to-our-position",level:2},{value:"Removing liquidity from our position",id:"removing-liquidity-from-our-position",level:2},{value:"Next Steps",id:"next-steps",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsxs)(n.p,{children:["This guide will cover how to modify a liquidity position by adding or removing liquidity on the SwapX V3 protocol. It is based on the ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/examples/tree/main/v3-sdk/modifying-position",children:"modifying a position code example"}),", found in the SwapX code examples ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/examples",children:"repository"}),". To run this example, check out the examples's ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/examples/blob/main/v3-sdk/modifying-position/README.md",children:"README"})," and follow the setup instructions."]}),"\n",(0,o.jsx)(n.admonition,{type:"info",children:(0,o.jsxs)(n.p,{children:["If you need a briefer on the SDK and to learn more about how these guides connect to the examples repository, please visit our ",(0,o.jsx)(n.a,{href:"/sdk/v3/guides/background",children:"background"})," page!"]})}),"\n",(0,o.jsxs)(n.p,{children:["In the SwapX V3 protocol, liquidity positions are represented using non-fungible tokens. In this guide we will use the ",(0,o.jsx)(n.code,{children:"NonfungiblePositionManager"})," class to help us mint a liquidity position and then modify the provided liquidity for the ",(0,o.jsx)(n.strong,{children:"USDC - DAI"})," pair. The inputs to our guide are the ",(0,o.jsx)(n.strong,{children:"two tokens"})," that we are pooling for, the ",(0,o.jsx)(n.strong,{children:"amount"})," of each token we are pooling for, the Pool ",(0,o.jsx)(n.strong,{children:"fee"})," and the ",(0,o.jsx)(n.strong,{children:"fraction"})," by which to ",(0,o.jsx)(n.strong,{children:"add and remove"})," from our position."]}),"\n",(0,o.jsxs)(n.p,{children:["The guide will ",(0,o.jsx)(n.strong,{children:"cover"}),":"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Adding liquidity to our position"}),"\n",(0,o.jsx)(n.li,{children:"Removing liquidity from our position"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"At the end of the guide, given the inputs above, we should be able to add or remove liquidity from a minted position with the press of a button and see the change reflected in our position and the balance of our tokens."}),"\n",(0,o.jsx)(n.p,{children:"For this guide, the following SwapX packages are used:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.npmjs.com/package/@swapx/v3-sdk",children:(0,o.jsx)(n.code,{children:"@swapx/v3-sdk"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://www.npmjs.com/package/@swapx/sdk-core",children:(0,o.jsx)(n.code,{children:"@swapx/sdk-core"})})}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["The core code of this guide can be found in ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/examples/blob/d34a53412dbf905802da2249391788a225719bb8/v3-sdk/modifying-position/src/example/Example.tsx#L33",children:(0,o.jsx)(n.code,{children:"addLiquidity()"})})," and ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/examples/blob/733d586070afe2c8cceb35d557a77eac7a19a656/v3-sdk/modifying-position/src/example/Example.tsx#L83",children:(0,o.jsx)(n.code,{children:"removeLiquidity()"})})]}),"\n",(0,o.jsxs)(n.admonition,{type:"note",children:[(0,o.jsxs)(n.p,{children:["This guide assumes you are familiar with our ",(0,o.jsx)(n.a,{href:"/sdk/v3/guides/liquidity/minting-position",children:"Minting a Position"})," guide. A minted position is required to add or remove liquidity from, so the buttons will be disabled until a position is minted."]}),(0,o.jsxs)(n.p,{children:["Also note that we do not need to give approval to the ",(0,o.jsx)(n.code,{children:"NonfungiblePositionManager"})," to transfer our tokens as we will have already done that when minting our position."]})]}),"\n",(0,o.jsx)(n.h2,{id:"configuration-and-utils",children:"Configuration and utils"}),"\n",(0,o.jsxs)(n.p,{children:["The example can be configured in the ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/examples/blob/d34a53412dbf905802da2249391788a225719bb8/v3-sdk/modifying-position/src/config.ts",children:(0,o.jsx)(n.code,{children:"config.ts"})})," file.\nThe ",(0,o.jsx)(n.code,{children:"CurrentConfig"})," object has this structure:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'export const CurrentConfig: ExampleConfig = {\n  env: Environment.LOCAL,\n  rpc: {\n    local: "http://localhost:8545",\n    mainnet: "https://mainnet.infura.io/v3/0ac57a06f2994538829c14745750d721",\n  },\n  wallet: {\n    address: "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266",\n    privateKey:\n      "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",\n  },\n  tokens: {\n    token0: USDC_TOKEN,\n    token0Amount: 1000,\n    token1: DAI_TOKEN,\n    token1Amount: 1000,\n    poolFee: FeeAmount.LOW,\n    fractionToRemove: 1,\n    fractionToAdd: 0.5,\n  },\n};\n'})}),"\n",(0,o.jsxs)(n.p,{children:["You should already be familiar with the ",(0,o.jsx)(n.code,{children:"rpc"}),", ",(0,o.jsx)(n.code,{children:"wallet"})," and token parameters, they are used in the same way as in the guides earlier in our v3-sdk series.\nThe ",(0,o.jsx)(n.code,{children:"fractionToAdd"})," variable is the multiplicator by which we will increase the Position. A fraction of ",(0,o.jsx)(n.strong,{children:"0.5"})," means we increase the liquidity by ",(0,o.jsx)(n.strong,{children:"50%"}),".\nThe ",(0,o.jsx)(n.code,{children:"fractionToRemove"})," variable is the fraction of the Position that we want to remove later in the guide. A fraction of ",(0,o.jsx)(n.strong,{children:"1"})," means we remove ",(0,o.jsx)(n.strong,{children:"100%"})," of the liquidity."]}),"\n",(0,o.jsx)(n.h2,{id:"adding-liquidity-to-our-position",children:"Adding liquidity to our position"}),"\n",(0,o.jsx)(n.p,{children:"Assuming we have already minted a position, our first step is to construct the modified position using our original position to calculate the amount by which we want to increase our current position:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"const fractionToAdd: number = ...\n\nconst amount0Increased: JSBI = fromReadableAmount(\n    readableAmount0 * fractionToAdd,\n    token0.decimals\n)\nconst amount1Increase: JSBI = fromReadableAmount(\n    readableAmount1 * fractionToAdd,\n    token1.decimals\n)\n\nconst positionToIncreaseBy = constructPosition(\n    amount0Increased,\n    amount1Increase\n  )\n)\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"fromReadableAmount()"})," function calculates the amount of tokens in their smallest unit, so for example 1 ETH would be ",(0,o.jsx)(n.code,{children:"1000000000000000000"})," Wei as ETH has 18 decimals."]}),"\n",(0,o.jsxs)(n.p,{children:["A better way to get the amounts might be to fetch them with the positionId directly from the blockchain.\nWe demonstrated how to do that in the ",(0,o.jsx)(n.a,{href:"/sdk/v3/guides/liquidity/position-data#fetching-positions",children:"first guide"})," of this series."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Pool, Position } from '@swapx/v3-sdk'\nimport JSBI from 'jsbi'\n\nfunction constructPosition(\n    amount0: JSBI,\n    amount1: JSBI\n): Position {\n    // create Pool same as in the previous guide\n    const pool = new Pool(...)\n\n    // create position using the maximum liquidity from input amounts\n    return Position.fromAmounts({\n        pool,\n        tickLower:\n            nearestUsableTick(pool.tickCurrent, pool.tickSpacing) -\n            pool.tickSpacing * 2,\n        tickUpper:\n            nearestUsableTick(pool.tickCurrent, pool.tickSpacing) +\n            pool.tickSpacing * 2,\n        amount0,\n        amount1,\n        useFullPrecision: true,\n    })\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The function receives two arguments, which are the amounts that are used to construct the Position instance. In this example, both of the arguments follow the same logic: we multiply the parameterized ",(0,o.jsx)(n.code,{children:"tokenAmount"})," by the parameterized ",(0,o.jsx)(n.code,{children:"fractionToAdd"})," since the new liquidity position will be added on top of the already minted liquidity position."]}),"\n",(0,o.jsxs)(n.p,{children:["We then need to construct an options object of type ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/v3-sdk/blob/08a7c050cba00377843497030f502c05982b1c43/src/nonfungiblePositionManager.ts#L77",children:(0,o.jsx)(n.code,{children:"AddLiquidityOptions"})})," similar to how we did in the minting case. In this case, we will use ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/v3-sdk/blob/08a7c050cba00377843497030f502c05982b1c43/src/nonfungiblePositionManager.ts#L75",children:(0,o.jsx)(n.code,{children:"IncreaseOptions"})}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import { AddLiquidityOptions } from "@swapx/v3-sdk";\n\nconst addLiquidityOptions: AddLiquidityOptions = {\n  deadline: Math.floor(Date.now() / 1000) + 60 * 20,\n  slippageTolerance: new Percent(50, 10_000),\n  tokenId,\n};\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Compared to minting, we have omitted the ",(0,o.jsx)(n.code,{children:"recipient"})," parameter and instead passed in the ",(0,o.jsx)(n.code,{children:"tokenId"})," of the position we previously minted.\nAs the Position already exists, the recipient doesn't change, instead the NonfungiblePositionManager contract can modify the existing Position by accessing it with its id."]}),"\n",(0,o.jsxs)(n.p,{children:["The tokenId can be fetched with the tokenOfOwnerByIndex function of the NonfungiblePositionManager Contract as described ",(0,o.jsx)(n.a,{href:"/sdk/v3/guides/liquidity/position-data#fetching-positions",children:"here"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["The newly created position along with the options object are then passed to the ",(0,o.jsx)(n.code,{children:"NonfungiblePositionManager"}),"'s ",(0,o.jsx)(n.code,{children:"addCallParameters"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import { NonfungiblePositionManager } from "@swapx/v3-sdk";\n\nconst positionToIncreaseBy = constructPosition(\n  CurrentConfig.tokens.amount0,\n  CurrentConfig.tokens.amount1\n);\n\nconst { calldata, value } = NonfungiblePositionManager.addCallParameters(\n  positionToIncreaseBy,\n  addLiquidityOptions\n);\n'})}),"\n",(0,o.jsxs)(n.p,{children:["The return values of ",(0,o.jsx)(n.code,{children:"addCallParameters"})," are the calldata and value of the transaction we need to submit to increase our position's liquidity. We can now build and execute the transaction:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import { ethers } from "ethers";\n\nconst transaction = {\n  data: calldata,\n  to: NONFUNGIBLE_POSITION_MANAGER_CONTRACT_ADDRESS,\n  value: value,\n  from: address,\n  maxFeePerGas: MAX_FEE_PER_GAS,\n  maxPriorityFeePerGas: MAX_PRIORITY_FEE_PER_GAS,\n};\n\nconst wallet = new ethers.Wallet(privateKey, provider);\n\nconst txRes = await wallet.sendTransaction(transaction);\n'})}),"\n",(0,o.jsxs)(n.p,{children:["We can get the Contract address for the NonfungiblePositionManager from ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/v3-periphery/blob/main/deploys.md",children:"Github"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"After pressing the button, note how the balance of USDC and DAI drops and our position's liquidity increases."}),"\n",(0,o.jsx)(n.h2,{id:"removing-liquidity-from-our-position",children:"Removing liquidity from our position"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"removeLiquidity"})," function is the mirror action of adding liquidity and will be somewhat similar as a result, requiring a position to already be minted."]}),"\n",(0,o.jsx)(n.p,{children:"To start, we create a position identical to the one we minted:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"const amount0: JSBI = fromReadableAmount(\n  readableAmount0 * fractionToAdd,\n  token0.decimals\n);\nconst amount1: JSBI = fromReadableAmount(\n  readableAmount1 * fractionToAdd,\n  token1.decimals\n);\n\nconst currentPosition = constructPosition(amount0, amount1);\n"})}),"\n",(0,o.jsxs)(n.p,{children:["We then need to construct an options object of type ",(0,o.jsx)(n.a,{href:"https://github.com/SwapX/v3-sdk/blob/08a7c050cba00377843497030f502c05982b1c43/src/nonfungiblePositionManager.ts#L138",children:(0,o.jsx)(n.code,{children:"RemoveLiquidityOptions"})}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import { RemoveLiquidityOptions } from "@swapx/v3-sdk";\nimport { Percent } from "@swapx/sdk-core";\n\nconst removeLiquidityOptions: RemoveLiquidityOptions = {\n  deadline: Math.floor(Date.now() / 1000) + 60 * 20,\n  slippageTolerance: new Percent(50, 10_000),\n  tokenId: positionId,\n  // percentage of liquidity to remove\n  liquidityPercentage: new Percent(0.5),\n  collectOptions,\n};\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Just as with adding liquidity, we have we have omitted the ",(0,o.jsx)(n.code,{children:"recipient"})," parameter and instead passed in the ",(0,o.jsx)(n.code,{children:"tokenId"})," of the position we previously minted."]}),"\n",(0,o.jsx)(n.p,{children:"We have also provide two additional parameters:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"liquidityPercentage"})," determines how much liquidity is removed from our initial position (as a ",(0,o.jsx)(n.code,{children:"Percentage"}),"), and transfers the removed liquidity back to our address. We set this percentage from our guide configuration ranging from 0 (0%) to 1 (100%). In this example we would remove 50% of the liquidity."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"https://github.com/SwapX/v3-sdk/blob/08a7c050cba00377843497030f502c05982b1c43/src/nonfungiblePositionManager.ts#L105",children:(0,o.jsx)(n.code,{children:"collectOptions"})})," gives us the option to collect the fees, if any, that we have accrued for this position. In this example, we won't collect any fees, so we provide zero values. If you'd like to see how to collect fees without modifying your position, check out our ",(0,o.jsx)(n.a,{href:"03-collecting-fees",children:"collecting fees"})," guide!"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:'import { CurrencyAmount } from "@swapx/sdk-core";\nimport { CollectOptions } from "@swapx/v3-sdk";\n\nconst collectOptions: Omit<CollectOptions, "tokenId"> = {\n  expectedCurrencyOwed0: CurrencyAmount.fromRawAmount(token0, 0),\n  expectedCurrencyOwed1: CurrencyAmount.fromRawAmount(token1, 0),\n  recipient: address,\n};\n'})}),"\n",(0,o.jsxs)(n.p,{children:["The position object along with the options object is passed to the ",(0,o.jsx)(n.code,{children:"NonfungiblePositionManager"}),"'s ",(0,o.jsx)(n.code,{children:"removeCallParameters"}),", similar to how we did in the adding liquidity case:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"const { calldata, value } = NonfungiblePositionManager.removeCallParameters(\n  currentPosition,\n  removeLiquidityOptions\n);\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The return values ",(0,o.jsx)(n.code,{children:"removeCallParameters"})," are the calldata and value that are needed to construct the transaction to remove liquidity from our position. We can build the transaction and send it for execution:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"const transaction = {\n  data: calldata,\n  to: NONFUNGIBLE_POSITION_MANAGER_CONTRACT_ADDRESS,\n  value: value,\n  from: address,\n  maxFeePerGas: MAX_FEE_PER_GAS,\n  maxPriorityFeePerGas: MAX_PRIORITY_FEE_PER_GAS,\n};\n\nconst txRes = await wallet.sendTransaction(transaction);\n"})}),"\n",(0,o.jsx)(n.p,{children:"After pressing the button, note how the balance of USDC and DAI increases and our position's liquidity drops."}),"\n",(0,o.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,o.jsxs)(n.p,{children:["Now that you can mint and modify a position, check out how to ",(0,o.jsx)(n.a,{href:"04-collecting-fees",children:"collect fees"})," from the position!"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>r});var t=i(6540);const o={},s=t.createContext(o);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);